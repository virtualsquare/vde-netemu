# Use the job name as the distribution. Valid names are stretch, buster,
# bionic, etc. Everything else is an invalid job name.

stages:
    - build

variables:
    DEBIAN_FRONTEND: noninteractive
    DEBEMAIL: Marco Giusti <marco.giusti3@studio.unibo.it>
    DISTRIBUTION: $CI_JOB_NAME
    DISTVER: 4
    DEBIAN_REVISION: -${DISTRIBUTION}${DISTVER}
    EPOCH: "1:"
    UPSTREAM_VERSION: 20130420

# vde-netemu changes rarely. Use a fixed version and change the building
# procedure once there is the need for it. Example of command to get the
# package version:
#
#   $ dpkg-parsechangelog | sed -rne 's/^Version: ([0-9.]+)[-+].*$$/\1/p'
.build-template: &build-deb
    stage: build
    script:
        - apt-get update
        - apt-get install -y build-essential debhelper devscripts libvdeplug-dev

        # Install load-sercure-files to use GPG private key to sign the
        # package and the SSH key to upload it to Launchpad.
        - apt-get install -y curl
        - curl --silent "https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/load-secure-files/-/raw/main/installer" | bash
        # Import the GnuPG key necessary to sign the changes file.
        - gpg --import .secure_files/public.key
        - gpg --import .secure_files/private.key

        - mkdir -p build/vde-netemu-"$UPSTREAM_VERSION"
        - cp -r debian/ Makefile vde-netemu.c build/vde-netemu-"$UPSTREAM_VERSION"
        - tar cvfz "build/vde-netemu_${UPSTREAM_VERSION}.orig.tar.gz" Makefile vde-netemu.c
        - cd build/vde-netemu-"$UPSTREAM_VERSION"
        - debchange --newversion "${EPOCH}${UPSTREAM_VERSION}${DEBIAN_REVISION}" "New upstream version"
        - debchange --release --distribution "${DISTRIBUTION}" ""

        # -b: Build the binary package only to avoid conflicts in the source
        #   package in different distributions.
        # -us: Do not sign the source package.
        # -uc: Do not sign the .buildinfo and .changes files.
        # -sd: Forces the exclusion of the original source and includes only the diff.
        # - dpkg-buildpackage -b -us -uc -sa
        - debuild -sd
    artifacts:
        paths:
            - build/*

# Debian 10, oldstable
buster:
    <<: *build-deb
    image: debian:buster

# Debian 11, oldstable
bullseye:
    <<: *build-deb
    image: debian:bullseye

# Debian 13, stable
bookworm:
    <<: *build-deb
    image: debian:bookworm

# Debian 13, testing
trixie:
    <<: *build-deb
    image: debian:trixie

# Debian unstable
sid:
    <<: *build-deb
    image: debian:sid

# Ubuntu 18.04 LTS
bionic:
    <<: *build-deb
    image: ubuntu:bionic

# Ubuntu 20.04 LTS
focal:
    <<: *build-deb
    image: ubuntu:focal

# Ubuntu 22.04 LTS
jammy:
    <<: *build-deb
    image: ubuntu:jammy

# Ubuntu 24.04 LTS
noble:
    <<: *build-deb
    image: ubuntu:noble
